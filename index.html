<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BAHUR TERMINAL PRO v2.1</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@200;400;600;700;900&family=JetBrains+Mono:wght@400;700&display=swap');

        :root {
            --bg: #000; --text: #fff; --border: rgba(255,255,255,0.08); --dim: #555; 
            --green: #00ff88; --red: #ff3b30; --accent: #fff; --orange: #ff9500; --blue: #007aff;
        }

        .bahur-terminal { min-height: 100vh; background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; transition: 0.5s; }
        .bahur-terminal.light { --bg: #ffffff; --text: #000000; --border: rgba(0,0,0,0.1); --dim: #888; --accent: #000; }

        ::-webkit-scrollbar { width: 0; } /* Скрытый скролл */
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .mono { font-family: 'JetBrains Mono', monospace; }

        /* ВАУ-ЗАГРУЗКА */
        .loader-wrap { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .loader-logo { font-size: 42px; font-weight: 900; letter-spacing: 0.5em; animation: logo-glow 2s infinite alternate; color: #fff; }
        @keyframes logo-glow { from { opacity: 0.1; } to { opacity: 1; } }

        /* HEADER */
        .header-manifest { text-align: center; margin-bottom: 40px; position: relative; }
        .logo-text { font-size: 48px; font-weight: 900; letter-spacing: 0.3em; margin: 0; color: var(--accent); }
        .theme-toggle { position: absolute; right: 0; top: 10px; background: none; border: 1px solid var(--border); cursor: pointer; padding: 8px; border-radius: 50%; color: var(--text); }

        /* ДАШБОРД */
        .dash-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; margin-bottom: 40px; }
        .stat-card { border: 1px solid var(--border); padding: 20px; background: var(--bg); border-left: 4px solid var(--accent); }
        .d-label { display: block; font-size: 8px; font-weight: 900; color: var(--dim); margin-bottom: 15px; letter-spacing: 2px; }
        .avg-price-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        .price-val { font-size: 18px; font-weight: 700; color: var(--accent); }

        /* БАДЖИ СИМВОЛОВ */
        .status-badge { font-size: 8px; font-weight: 900; padding: 2px 6px; margin-left: 8px; border: 1px solid var(--accent); color: var(--accent); letter-spacing: 1px; }
        .status-badge.mod { border-color: var(--blue); color: var(--blue); }
        .status-badge.sim-l { border-color: var(--orange); color: var(--orange); }
        .status-badge.out { border-color: var(--red); color: var(--red); }

        /* ФИЛЬТРЫ */
        .filter-section { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 30px; border-top: 1px solid var(--border); padding-top: 20px; }
        .btn-tabs button { background: none; border: 1px solid var(--border); color: var(--dim); padding: 8px 15px; font-size: 10px; font-weight: 700; cursor: pointer; margin-right: 5px; }
        .btn-tabs button.active { border-color: var(--accent); color: var(--accent); background: rgba(128,128,128,0.1); }

        /* ТАБЛИЦА */
        .table-container { border: 1px solid var(--border); overflow-x: auto; }
        .grid-row { display: grid; grid-template-columns: 60px 1fr 80px 120px 120px var(--w-cols); border-bottom: 1px solid var(--border); transition: 0.3s; }
        .grid-row.is-out { opacity: 0.3; filter: grayscale(1); }
        .grid-header { background: var(--bg); border-bottom: 2px solid var(--accent); position: sticky; top: 0; z-index: 100; font-size: 8px; font-weight: 900; color: var(--dim); }
        .cell { padding: 15px; display: flex; align-items: center; border-right: 1px solid var(--border); }
        .cell.center { justify-content: center; }

        /* ЭФФЕКТ СКРОЛЛА */
        .scrolling .grid-row { filter: blur(2px); opacity: 0.5; }
        .scrolling .grid-row:hover { filter: blur(0); opacity: 1; }

        @media (max-width: 900px) {
            .grid-header, .grid-row { grid-template-columns: 40px 1fr var(--w-cols); }
            .desk-only { display: none; }
        }
    </style>
</head>
<body>

<div id="app">
    <div v-if="initLoading" class="loader-wrap"><div class="loader-logo">BAHUR</div></div>

    <div :class="['bahur-terminal', { 'light': !isDark }]">
        <div class="container">
            
            <header class="header-manifest">
                <h1 class="logo-text">BAHUR</h1>
                <div style="font-size: 10px; color: var(--dim); letter-spacing: 4px; margin-top: 10px;">OFFICE DUBAI</div>
                <button @click="isDark = !isDark" class="theme-toggle">
                    <span v-if="isDark">☀</span><span v-else>☾</span>
                </button>
            </header>

            <section class="dashboard">
                <div class="dash-grid">
                    <div class="stat-card">
                        <label class="d-label">АНАЛИТИКА ТЕКУЩЕЙ ВЫБОРКИ ({{ stats.total }})</label>
                        <div class="avg-price-grid">
                            <div v-show="colVis.p50"><span class="price-val mono">{{ stats.avg50 }}₽</span><div style="font-size: 7px; opacity: 0.5;">СРЕДНЯЯ 50Г</div></div>
                            <div v-show="colVis.p500"><span class="price-val mono">{{ stats.avg500 }}₽</span><div style="font-size: 7px; opacity: 0.5;">СРЕДНЯЯ 500Г</div></div>
                            <div v-show="colVis.p1000"><span class="price-val mono">{{ stats.avg1000 }}₽</span><div style="font-size: 7px; opacity: 0.5;">СРЕДНЯЯ 1КГ</div></div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <label class="d-label">СТАТИСТИКА ПО ФАБРИКАМ</label>
                        <div v-for="(val, key) in stats.factories" :key="key" style="display: flex; justify-content: space-between; font-size: 10px; margin-bottom: 5px;">
                            <span class="mono">{{ key }}</span>
                            <span class="mono" style="color: var(--accent)">{{ val.percent }}%</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <label class="d-label">ГРАДАЦИЯ КАЧЕСТВА</label>
                        <div v-for="(val, key) in stats.quality" :key="key" style="display: flex; justify-content: space-between; font-size: 10px; margin-bottom: 5px;">
                            <span class="mono">{{ key }}</span>
                            <span class="mono" style="color: var(--accent)">{{ val }}%</span>
                        </div>
                    </div>
                </div>
            </section>

            <section class="filter-section">
                <div class="filter-group" style="flex: 1; min-width: 250px;">
                    <label class="d-label">ПОИСК ПО НАЗВАНИЮ</label>
                    <input v-model="search" style="width: 100%; background: none; border: 1px solid var(--border); color: var(--accent); padding: 10px; outline: none;" placeholder="...">
                </div>
                <div class="filter-group">
                    <label class="d-label">ФАБРИКА / СТАТУС</label>
                    <div class="btn-tabs">
                        <button v-for="f in ['ВСЕ', 'LUZI', 'EPS', 'SELUZ']" :key="f" :class="{ active: activeFactory === f }" @click="activeFactory = f">{{ f }}</button>
                        <button :class="{ active: showOnlyNew }" @click="showOnlyNew = !showOnlyNew">NEW (+)</button>
                    </div>
                </div>
                <div class="filter-group">
                    <label class="d-label">СОРТИРОВКА</label>
                    <div class="btn-tabs">
                        <button v-for="s in sortOpts" :key="s.val" :class="{ active: sortBy === s.val }" @click="sortBy = s.val">{{ s.label }}</button>
                    </div>
                </div>
            </section>

            <div class="table-container" :class="{ 'scrolling': isScrolling }">
                <div class="grid-row grid-header" :style="{ '--w-cols': gridWidth }">
                    <div class="cell center">№</div>
                    <div class="cell">АРОМАТ / БРЕНД</div>
                    <div class="cell center desk-only">ПОЛ</div>
                    <div class="cell center desk-only">ФАБРИКА</div>
                    <div class="cell center desk-only">КАЧЕСТВО</div>
                    <div v-if="colVis.p50" class="cell center">50Г <span @click="toggleCol('p50')" style="cursor:pointer; margin-left:5px; color:var(--red);">✕</span></div>
                    <div v-if="colVis.p500" class="cell center">500Г <span @click="toggleCol('p500')" style="cursor:pointer; margin-left:5px; color:var(--red);">✕</span></div>
                    <div v-if="colVis.p1000" class="cell center">1КГ <span @click="toggleCol('p1000')" style="cursor:pointer; margin-left:5px; color:var(--red);">✕</span></div>
                </div>

                <div v-for="p in sortedProducts" :key="p.id" :class="['grid-row', { 'is-out': p.statusRaw === '-' }]" @click="p.link && window.open(p.link, '_blank')">
                    <div class="cell center mono" style="font-size: 10px; opacity: 0.5;">{{ p.id }}</div>
                    <div class="cell" style="flex-direction: column; align-items: flex-start;">
                        <span class="mono" style="font-size: 8px; opacity: 0.4;">{{ p.brand }}</span>
                        <div style="display: flex; align-items: center; flex-wrap: wrap; gap: 4px;">
                            <span style="font-weight: 700;">{{ p.name }}</span>
                            <span v-if="p.statusRaw === '+'" class="status-badge">NEW</span>
                            <span v-if="p.statusRaw === '*'" class="status-badge mod">MOD</span>
                            <span v-if="p.statusRaw === '#'" class="status-badge sim-l">SIM-L</span>
                            <span v-if="p.statusRaw === '-'" class="status-badge out">OUT</span>
                        </div>
                    </div>
                    <div class="cell center desk-only mono" style="font-size: 10px;">{{ p.gender }}</div>
                    <div class="cell center desk-only mono" style="font-size: 10px;">{{ p.factory }}</div>
                    <div class="cell center desk-only mono" style="font-size: 10px;">{{ p.quality }}</div>
                    <div v-if="colVis.p50" class="cell center mono">{{ p.p50 }}₽</div>
                    <div v-if="colVis.p500" class="cell center mono">{{ p.p500 }}₽</div>
                    <div v-if="colVis.p1000" class="cell center mono" style="font-weight: 900; color: var(--accent);">{{ p.p1000 }}₽</div>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
const { createApp, ref, computed, onMounted } = Vue;

createApp({
    setup() {
        const isDark = ref(true);
        const initLoading = ref(true);
        const products = ref([]);
        const search = ref('');
        const activeFactory = ref('ВСЕ');
        const sortBy = ref('id');
        const showOnlyNew = ref(false);
        const colVis = ref({ p50: true, p500: true, p1000: true });
        const isScrolling = ref(false);
        let scrollTimer;

        const sortOpts = [{ label: 'ID', val: 'id' }, { label: 'ЦЕНА ↑', val: 'asc' }, { label: 'ЦЕНА ↓', val: 'desc' }];

        const loadData = async () => {
            const url = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTtT4zLEY49maKt0VxanZWA2ORKO1h39Mc5wB-XcZclDTmWfroFxQNAPxomg3x0-w/pub?gid=1234145733&single=true&output=csv';
            try {
                const res = await fetch(url);
                const text = await res.text();
                const rows = text.split(/\r?\n/).filter(line => line.trim()).slice(1);
                
                products.value = rows.map(row => {
                    const col = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c => c.replace(/^"|"$/g, '').trim());
                    return {
                        id: parseInt(col[0]),
                        link: col[1],
                        brand: col[2],
                        name: col[3],
                        gender: col[4] === 'm' ? 'МУЖ' : col[4] === 'w' ? 'ЖЕН' : 'УНИ',
                        factory: col[5] || '—',
                        quality: col[6] || 'Q1',
                        p50: parseInt(col[7]) || 0,
                        p500: parseInt(col[8]) || 0,
                        p1000: parseInt(col[9]) || 0,
                        statusRaw: col[10], // Наш спец-символ (+, -, *, #)
                        salesTotal: col[11] || 0, // Будущая статистика
                        salesTrend: col[12] || 0  // Будущая статистика
                    };
                }).filter(p => !isNaN(p.id));
            } catch (e) { console.error(e); }
            finally { setTimeout(() => initLoading.value = false, 1500); }
        };

        const sortedProducts = computed(() => {
            let list = products.value.filter(p => {
                const s = search.value.toLowerCase();
                const matchSearch = p.name.toLowerCase().includes(s) || p.brand.toLowerCase().includes(s);
                const matchFactory = activeFactory.value === 'ВСЕ' || p.factory === activeFactory.value;
                const matchNew = !showOnlyNew.value || p.statusRaw === '+';
                return matchSearch && matchFactory && matchNew;
            });
            if (sortBy.value === 'asc') list.sort((a,b) => a.p1000 - b.p1000);
            else if (sortBy.value === 'desc') list.sort((a,b) => b.p1000 - a.p1000);
            else list.sort((a,b) => a.id - b.id);
            return list;
        });

        const stats = computed(() => {
            const p = sortedProducts.value;
            const count = p.length || 1;
            let s50 = 0, s500 = 0, s1000 = 0;
            const facts = { 'LUZI': 0, 'EPS': 0, 'SELUZ': 0 };
            const quals = { 'TOP': 0, 'Q1': 0, 'Q2': 0 };

            p.forEach(i => {
                s50 += i.p50; s500 += i.p500; s1000 += i.p1000;
                if (facts[i.factory] !== undefined) facts[i.factory]++;
                if (quals[i.quality] !== undefined) quals[i.quality]++;
            });

            const factories = {};
            Object.keys(facts).forEach(k => factories[k] = { percent: Math.round((facts[k] / count) * 100) });

            return {
                total: p.length,
                avg50: Math.round(s50 / count),
                avg500: Math.round(s500 / count),
                avg1000: Math.round(s1000 / count),
                factories,
                quality: { 'TOP': Math.round((quals['TOP'] / count) * 100), 'Q1': Math.round((quals['Q1'] / count) * 100), 'Q2': Math.round((quals['Q2'] / count) * 100) }
            };
        });

        const gridWidth = computed(() => {
            let w = [];
            if (colVis.value.p50) w.push('80px');
            if (colVis.value.p500) w.push('80px');
            if (colVis.value.p1000) w.push('100px');
            return w.join(' ');
        });

        const toggleCol = (c) => {
            const visibleCount = Object.values(colVis.value).filter(v => v).length;
            if (visibleCount > 1 || !colVis.value[c]) colVis.value[c] = !colVis.value[c];
        };

        onMounted(() => {
            loadData();
            window.addEventListener('scroll', () => {
                isScrolling.value = true;
                clearTimeout(scrollTimer);
                scrollTimer = setTimeout(() => isScrolling.value = false, 150);
            }, { passive: true });
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.ready();
                window.Telegram.WebApp.expand();
            }
        });

        return { isDark, initLoading, search, activeFactory, sortBy, showOnlyNew, colVis, sortedProducts, stats, sortOpts, gridWidth, toggleCol, isScrolling };
    }
}).mount('#app');
</script>
</body>
</html>
